name: Translations Diff

on:
  pull_request:
    types: [opened, edited, synchronize, ready_for_review]
    branches:
      - 'development'
      - 'new/**'

jobs:
  translation:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Ref Base
        uses: actions/checkout@v2
        with:
          path: neve-head
      - name: FRESH Makepot BASE
        run: |
         cd neve-head
         ls languages/
         npm run build:makepot
         ls languages/
      - name: Checkout Ref Head
        uses: actions/checkout@v2
        with:
          ref: development
          path: neve-base
      - name: FRESH Makepot HEAD
        run: |
         cd neve-base
         ls languages/
         npm run build:makepot
         ls languages/
      - name: Find Comment
        uses: peter-evans/find-comment@v1
        id: find_coomment
        with:
          issue-number: ${{ github.event.pull_request.number }}
          comment-author: 'pirate-bot'
          body-includes: PR has POT difference
      - name: Install PODiff
        run: |
          curl -o podiff.gz ftp://download.gnu.org.ua/pub/releases/podiff/podiff-1.3.tar.gz
          tar -xf podiff.gz
          cd podiff-1.3
          make
          ls
          mv ./podiff $GITHUB_WORKSPACE/bin
          echo "$GITHUB_WORKSPACE/bin" >> $GITHUB_PATH
          cd ..
          ls $GITHUB_WORKSPACE/bin
      - name: Run Podiff
        run: |
          echo "$PATH"
          ${GITHUB_WORKSPACE}/neve-head/bin/pot-diff.sh ./neve-base/languages/neve.pot ./neve-head/languages/neve.pot $PERCENT_TRESHOLD
      - name: Step failed Create or update comment
        if: ${{ failure() }}
        uses: peter-evans/create-or-update-comment@v1
        with:
          comment-id: ${{ steps.find_coomment.outputs.comment-id }}
          token: ${{ secrets.BOT_TOKEN }}
          issue-number: ${{ github.event.pull_request.number }}
          body: |
            :crossed_flags::guardsman: PR has POT difference cc: @selul
          edit-mode: replace
      - name: Delete comment
        uses: jungwinter/comment@v1
        if: steps.find_coomment.outputs.comment-id != ''
        with:
          type: delete
          comment_id: ${{ steps.find_coomment.outputs.comment-id }}
          token: ${{ secrets.BOT_TOKEN }}
